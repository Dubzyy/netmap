<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetMap - Network Topology</title>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #cy { width: 100%; height: 100vh; background: #0f172a; }
        .info { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 15px; border-radius: 8px; max-width: 300px; }
        .btn { position: absolute; top: 20px; left: 20px; background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="cy"></div>
    <button class="btn" onclick="loadTopology()">üîÑ Refresh</button>
    <div class="info" id="info">
        <h3>NetMap üó∫Ô∏è</h3>
        <div id="details">Loading...</div>
    </div>

    <script>
        let cy;
        const API = 'http://10.10.1.8:8000/api/topology/';

        async function loadTopology() {
            try {
                const res = await fetch(API);
                const data = await res.json();
                
                const elements = [];
                
                // Add nodes
                data.nodes.forEach(n => {
                    elements.push({
                        group: 'nodes',
                        data: { id: String(n.id), label: n.label, type: n.type },
                        position: n.position
                    });
                });
                
                // Add edges  
                data.edges.forEach(e => {
                    console.log('Adding edge:', e);  // Debug log
                    elements.push({
                        group: 'edges',
                        data: {
                            id: 'edge-' + String(e.id),
                            source: String(e.source),
                            target: String(e.target),
                            label: `${e.source_interface} ‚Üî ${e.target_interface}`,
                            bw: e.bandwidth
                        }
                    });
                });
                
                console.log('Total elements:', elements.length);  // Debug log

                if (!cy) {
                    cy = cytoscape({
                        container: document.getElementById('cy'),
                        elements: elements,
                        style: [
                            {
                                selector: 'node',
                                style: {
                                    'background-color': '#ef4444',
                                    'label': 'data(label)',
                                    'color': '#fff',
                                    'text-valign': 'bottom',
                                    'text-margin-y': 5,
                                    'width': 80,
                                    'height': 80
                                }
                            },
                            {
                                selector: 'edge',
                                style: {
                                    'width': 8,
                                    'line-color': '#10b981',
                                    'target-arrow-color': '#10b981',
                                    'target-arrow-shape': 'triangle'
                                }
                            }
                        ],
                        layout: { name: 'preset' }
                    });
                } else {
                    cy.elements().remove();
                    cy.add(elements);
                }
                
                document.getElementById('details').innerHTML = 
                    `‚úì Nodes: ${data.nodes.length}<br>‚úì Links: ${data.edges.length}`;
                    
            } catch (e) {
                document.getElementById('details').innerHTML = `Error: ${e.message}`;
            }
        }

        loadTopology();
        setInterval(loadTopology, 30000);
    </script>
</body>
</html>
