<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetMap - Network Topology Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow: hidden; background: #f8f9fa; }
        #cy { width: 100%; height: 100vh; background: #ffffff; }

        .toolbar {
            position: absolute; top: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
            border-bottom: 1px solid #e5e7eb;
        }

        .toolbar h1 { color: #1f2937; font-size: 18px; margin-right: auto; }

        .btn {
            background: #3b82f6; color: white; border: none;
            padding: 8px 16px; border-radius: 6px; cursor: pointer;
            font-size: 13px; font-weight: 600; transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .btn:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }

        .panel {
            position: absolute; top: 70px;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 10px; padding: 20px;
            color: #1f2937; max-height: calc(100vh - 90px);
            overflow-y: auto; z-index: 50;
        }

        .panel-right { right: 20px; width: 320px; }
        .panel h3 { margin: 0 0 15px 0; font-size: 16px; color: #111827; }
        .stat { margin: 8px 0; font-size: 14px; }
        .stat-label { color: #6b7280; }
        .stat-value { color: #10b981; font-weight: 600; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 13px; color: #6b7280; }
        .form-group input, .form-group select {
            width: 100%; padding: 8px;
            background: #f9fafb; border: 1px solid #d1d5db;
            border-radius: 6px; color: #1f2937; font-size: 13px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: #3b82f6; background: white;
        }

        .checkbox-group { display: flex; align-items: center; gap: 8px; }
        .checkbox-group input { width: auto; }

        .file-input-wrapper {
            position: relative; overflow: hidden;
            display: inline-block; width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute; left: -9999px;
        }

        .file-input-label {
            display: block; padding: 10px;
            background: #f9fafb; border: 2px dashed #d1d5db;
            border-radius: 6px; text-align: center;
            cursor: pointer; transition: all 0.2s;
            color: #6b7280;
        }

        .file-input-label:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #3b82f6;
        }

        .image-preview {
            margin-top: 10px; text-align: center;
        }

        .image-preview img {
            max-width: 150px; max-height: 150px;
            border-radius: 8px; border: 2px solid #e5e7eb;
        }

        .legend {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 10px; padding: 15px;
            color: #1f2937; z-index: 50;
        }

        .legend-item {
            display: flex; align-items: center;
            margin: 5px 0; font-size: 13px;
        }

        .legend-icon {
            width: 24px; height: 24px;
            margin-right: 10px; border-radius: 4px;
        }

        .modal {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 200;
            align-items: center; justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white; border-radius: 10px;
            padding: 30px; max-width: 500px; width: 90%;
            color: #1f2937; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 20px;
        }

        .modal-header h2 { font-size: 20px; margin: 0; color: #111827; }
        .close-btn {
            background: none; border: none;
            color: #6b7280; font-size: 24px; cursor: pointer;
        }

        .form-actions {
            display: flex; gap: 10px; margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <h1>üó∫Ô∏è NetMap</h1>
        <button class="btn" onclick="loadTopology()">üîÑ Refresh</button>
        <button class="btn btn-success" onclick="showAddDeviceModal()">‚ûï Add Device</button>
        <button class="btn btn-success" onclick="showAddLinkModal()">üîó Add Link</button>
        <button class="btn btn-secondary" onclick="cy.fit()">üéØ Fit View</button>
        <button class="btn btn-secondary" onclick="cy.zoom(cy.zoom() * 1.2); cy.center()">üîç Zoom In</button>
        <button class="btn btn-secondary" onclick="cy.zoom(cy.zoom() * 0.8); cy.center()">üîç Zoom Out</button>
        <button class="btn btn-secondary" id="line-toggle-btn" onclick="toggleCurvedLines()">üìê Straight Lines</button>
    </div>

    <div id="cy"></div>

    <div class="panel panel-right" id="info-panel">
        <h3>Network Info</h3>
        <div id="details">
            <div class="stat">Click on devices or links for details</div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="legend-icon" style="background: #ef4444;">üî•</div><span>Firewall</span></div>
        <div class="legend-item"><div class="legend-icon" style="background: #3b82f6;">üîÄ</div><span>Switch</span></div>
        <div class="legend-item"><div class="legend-icon" style="background: #8b5cf6;">üíª</div><span>Hypervisor</span></div>
        <div class="legend-item"><div class="legend-icon" style="background: #10b981;">üñ•Ô∏è</div><span>Server</span></div>
        <div class="legend-item"><div class="legend-icon" style="background: #f59e0b;">üì°</div><span>Router</span></div>
        <div class="legend-item"><div class="legend-icon" style="background: #6b7280;">üåê</div><span>ISP/External</span></div>
    </div>

    <div class="modal" id="add-device-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Device</h2>
                <button class="close-btn" onclick="closeModal('add-device-modal')">&times;</button>
            </div>
            <form id="device-form" onsubmit="createDevice(event)">
                <div class="form-group">
                    <label>Device Name *</label>
                    <input type="text" id="device-name" required placeholder="e.g., ISP Router">
                </div>
                <div class="form-group">
                    <label>Device Type *</label>
                    <select id="device-type" required>
                        <option value="firewall">Firewall</option>
                        <option value="switch">Switch</option>
                        <option value="router">Router</option>
                        <option value="hypervisor">Hypervisor</option>
                        <option value="server">Server</option>
                        <option value="isp">ISP Equipment</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Device Icon (Upload Image)</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="device-icon-file" accept="image/png,image/jpeg,image/svg+xml" onchange="previewImage(event)">
                        <label for="device-icon-file" class="file-input-label">
                            üìÅ Click to upload icon (PNG, JPG, SVG)
                        </label>
                    </div>
                    <div id="image-preview" class="image-preview"></div>
                </div>
                <div class="form-group">
                    <label>IP Address *</label>
                    <input type="text" id="device-ip" required placeholder="e.g., 192.168.1.1">
                </div>
                <div class="form-group">
                    <label>Prometheus Instance (optional)</label>
                    <input type="text" id="device-prometheus" placeholder="Leave blank for dummy nodes">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="device-monitored" checked>
                    <label for="device-monitored" style="margin: 0;">Has Prometheus Metrics</label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Create Device</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-device-modal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="add-link-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Link</h2>
                <button class="close-btn" onclick="closeModal('add-link-modal')">&times;</button>
            </div>
            <form id="link-form" onsubmit="createLink(event)">
                <div class="form-group">
                    <label>Source Device *</label>
                    <select id="link-source" required></select>
                </div>
                <div class="form-group">
                    <label>Source Interface *</label>
                    <input type="text" id="link-source-if" required placeholder="e.g., ae0">
                </div>
                <div class="form-group">
                    <label>Target Device *</label>
                    <select id="link-target" required></select>
                </div>
                <div class="form-group">
                    <label>Target Interface *</label>
                    <input type="text" id="link-target-if" required placeholder="e.g., bond0">
                </div>
                <div class="form-group">
                    <label>Bandwidth Capacity (Mbps) *</label>
                    <input type="number" id="link-capacity" required placeholder="e.g., 1000">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Create Link</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-link-modal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let cy;
        const API = 'http://10.10.1.8:8000/api';
        let allDevices = [];
        let uploadedImageBase64 = '';
        let useCurvedLines = true;

        const deviceConfig = {
            firewall: { color: '#ef4444', icon: 'üî•' },
            switch: { color: '#3b82f6', icon: 'üîÄ' },
            router: { color: '#f59e0b', icon: 'üì°' },
            hypervisor: { color: '#8b5cf6', icon: 'üíª' },
            server: { color: '#10b981', icon: 'üñ•Ô∏è' },
            isp: { color: '#6b7280', icon: 'üåê' }
        };

        // Load saved preferences
        function loadPreferences() {
            const savedCurved = localStorage.getItem('netmap-curved-lines');
            if (savedCurved !== null) {
                useCurvedLines = savedCurved === 'true';
            }
            updateLineToggleButton();
        }

        function updateLineToggleButton() {
            const btn = document.getElementById('line-toggle-btn');
            btn.innerHTML = useCurvedLines ? 'üìê Straight Lines' : 'üìê Curved Lines';
        }

        function toggleCurvedLines() {
            useCurvedLines = !useCurvedLines;
            localStorage.setItem('netmap-curved-lines', useCurvedLines);
            updateLineToggleButton();
            
            if (cy) {
                cy.style()
                    .selector('edge')
                    .style({
                        'curve-style': useCurvedLines ? 'unbundled-bezier' : 'straight',
                        'control-point-distances': useCurvedLines ? [40, -40] : [],
                        'control-point-weights': useCurvedLines ? [0.25, 0.75] : []
                    })
                    .update();
            }
        }

        function saveViewport() {
            if (!cy) return;
            const viewport = {
                zoom: cy.zoom(),
                pan: cy.pan()
            };
            localStorage.setItem('netmap-viewport', JSON.stringify(viewport));
        }

        function restoreViewport() {
            const saved = localStorage.getItem('netmap-viewport');
            if (saved && cy) {
                try {
                    const viewport = JSON.parse(saved);
                    cy.viewport({
                        zoom: viewport.zoom,
                        pan: viewport.pan
                    });
                } catch (e) {
                    console.error('Error restoring viewport:', e);
                }
            }
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImageBase64 = e.target.result;
                document.getElementById('image-preview').innerHTML =
                    `<img src="${uploadedImageBase64}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
        }

        async function loadTopology() {
            try {
                const res = await fetch(`${API}/topology/`);
                const data = await res.json();
                allDevices = data.nodes;
                const elements = [];

                data.nodes.forEach(n => {
                    const config = deviceConfig[n.type] || deviceConfig.server;
                    const hasCustomIcon = n.icon && n.icon.startsWith('data:image');

                    elements.push({
                        group: 'nodes',
                        data: {
                            id: String(n.id),
                            label: n.label,
                            type: n.type,
                            ip: n.ip,
                            is_monitored: n.is_monitored,
                            icon: hasCustomIcon ? n.icon : '',
                            hasCustomIcon: hasCustomIcon,
                            color: config.color
                        },
                        position: n.position
                    });
                });

                data.edges.forEach(e => {
                    elements.push({
                        group: 'edges',
                        data: {
                            id: 'edge-' + String(e.id),
                            dbId: e.id,
                            source: String(e.source),
                            target: String(e.target),
                            source_if: e.source_interface,
                            target_if: e.target_interface,
                            bw: e.bandwidth
                        }
                    });
                });

                if (!cy) {
                    initCytoscape(elements);
                } else {
                    // Save viewport before update
                    const viewport = {
                        zoom: cy.zoom(),
                        pan: cy.pan()
                    };
                    
                    // Update elements
                    cy.elements().remove();
                    cy.add(elements);
                    cy.layout({ name: 'preset' }).run();
                    
                    // Restore viewport after brief delay
                    setTimeout(() => {
                        cy.viewport(viewport);
                    }, 50);
                }

                updateInfoPanel(new Date().toLocaleTimeString(), data.nodes.length, data.edges.length);
            } catch (e) {
                console.error('Load error:', e);
                document.getElementById('details').innerHTML = `<div style="color: #ef4444;">Error: ${e.message}</div>`;
            }
        }

        function updateInfoPanel(time, nodes, links) {
            document.getElementById('details').innerHTML = `
                <div class="stat"><span class="stat-label">Updated:</span> <span class="stat-value">${time}</span></div>
                <div class="stat"><span class="stat-label">Nodes:</span> <span class="stat-value">${nodes}</span></div>
                <div class="stat"><span class="stat-label">Links:</span> <span class="stat-value">${links}</span></div>
            `;
        }

        function initCytoscape(elements) {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': 'white',
                            'background-opacity': 1,
                            'background-image': ele => {
                                if (ele.data('hasCustomIcon')) {
                                    return ele.data('icon');
                                }
                                return 'none';
                            },
                            'background-fit': 'contain',
                            'background-clip': 'none',
                            'border-width': 2,
                            'border-color': '#d1d5db',
                            'border-style': 'solid',
                            'shape': 'roundrectangle',
                            'label': 'data(label)',
                            'color': '#374151',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'width': ele => ele.data('hasCustomIcon') ? 80 : 100,
                            'height': ele => ele.data('hasCustomIcon') ? 80 : 60,
                            'font-size': 12,
                            'font-weight': '600',
                            'text-wrap': 'wrap',
                            'text-max-width': 90,
                            'padding': 10
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#9ca3af',
                            'target-arrow-shape': 'none',
                            'curve-style': useCurvedLines ? 'unbundled-bezier' : 'straight',
                            'control-point-distances': useCurvedLines ? [40, -40] : [],
                            'control-point-weights': useCurvedLines ? [0.25, 0.75] : [],
                            'label': ele => {
                                const bw = ele.data('bw');
                                if (!bw || (bw.inbound === 0 && bw.outbound === 0)) return '';
                                return `${bw.inbound}M | ${bw.outbound}M`;
                            },
                            'font-size': 9,
                            'color': '#6b7280',
                            'text-background-color': '#ffffff',
                            'text-background-opacity': 0.95,
                            'text-background-padding': 2
                        }
                    },
                    {
                        selector: 'node:selected',
                        style: {
                            'border-width': 3,
                            'border-color': '#3b82f6'
                        }
                    }
                ],
                layout: { name: 'preset' },
                minZoom: 0.3,
                maxZoom: 3
            });

            cy.on('tap', 'edge', function(evt) {
                const edge = evt.target;
                const bw = edge.data('bw');
                const src_if = edge.data('source_if');
                const tgt_if = edge.data('target_if');
                const dbId = edge.data('dbId');

                if (bw) {
                    const utilColor = bw.utilization > 80 ? '#ef4444' : bw.utilization > 50 ? '#f59e0b' : '#10b981';
                    document.getElementById('details').innerHTML = `
                        <h3 style="margin: 0 0 10px 0; font-size: 16px;">${src_if} ‚Üî ${tgt_if}</h3>
                        <div class="stat"><span class="stat-label">‚Üì Inbound:</span> <span class="stat-value">${bw.inbound} Mbps</span></div>
                        <div class="stat"><span class="stat-label">‚Üë Outbound:</span> <span class="stat-value">${bw.outbound} Mbps</span></div>
                        <div class="stat"><span class="stat-label">Capacity:</span> <span class="stat-value">${bw.capacity} Mbps</span></div>
                        <div class="stat"><span class="stat-label">Utilization:</span> <span style="color: ${utilColor}; font-weight: 600;">${bw.utilization}%</span></div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-danger" onclick="deleteLink(${dbId})">üóëÔ∏è Delete Link</button>
                        </div>
                    `;
                }
            });

            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                const monitored = node.data('is_monitored') ? 'Yes' : 'No (Dummy)';
                const iconDisplay = node.data('hasCustomIcon') ? '<img src="' + node.data('icon') + '" style="max-width: 80px; margin-bottom: 10px;">' : '';

                document.getElementById('details').innerHTML = `
                    <div style="text-align: center; margin-bottom: 10px;">${iconDisplay}</div>
                    <h3 style="margin: 0 0 10px 0; font-size: 18px; text-align: center;">${node.data('label')}</h3>
                    <div class="stat"><span class="stat-label">Type:</span> <span class="stat-value">${node.data('type')}</span></div>
                    <div class="stat"><span class="stat-label">IP:</span> <span class="stat-value">${node.data('ip')}</span></div>
                    <div class="stat"><span class="stat-label">Monitored:</span> <span class="stat-value">${monitored}</span></div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-danger" onclick="deleteDevice(${node.id()})">üóëÔ∏è Delete Device</button>
                    </div>
                `;
            });

            cy.on('dragfree', 'node', async function(evt) {
                const node = evt.target;
                const pos = node.position();
                
                console.log(`Saving position for device ${node.id()}: x=${Math.round(pos.x)}, y=${Math.round(pos.y)}`);
                
                try {
                    const response = await fetch(`${API}/device/${node.id()}/position/`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ x: Math.round(pos.x), y: Math.round(pos.y) })
                    });
                    
                    if (response.ok) {
                        console.log(`Position saved successfully for device ${node.id()}`);
                    } else {
                        console.error(`Failed to save position for device ${node.id()}:`, await response.text());
                    }
                } catch (error) {
                    console.error('Error saving position:', error);
                }
            });

            // Save viewport on changes
            cy.on('zoom pan', saveViewport);

            // Restore saved viewport
            setTimeout(() => restoreViewport(), 100);
        }

        function showAddDeviceModal() {
            uploadedImageBase64 = '';
            document.getElementById('image-preview').innerHTML = '';
            document.getElementById('add-device-modal').classList.add('active');
        }

        function showAddLinkModal() {
            const sourceSelect = document.getElementById('link-source');
            const targetSelect = document.getElementById('link-target');
            sourceSelect.innerHTML = '';
            targetSelect.innerHTML = '';
            allDevices.forEach(device => {
                sourceSelect.innerHTML += `<option value="${device.id}">${device.label}</option>`;
                targetSelect.innerHTML += `<option value="${device.id}">${device.label}</option>`;
            });
            document.getElementById('add-link-modal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function createDevice(event) {
            event.preventDefault();
            const data = {
                name: document.getElementById('device-name').value,
                device_type: document.getElementById('device-type').value,
                ip_address: document.getElementById('device-ip').value,
                prometheus_instance: document.getElementById('device-prometheus').value || '',
                is_monitored: document.getElementById('device-monitored').checked,
                icon: uploadedImageBase64,
                position_x: 400,
                position_y: 400
            };

            try {
                const res = await fetch(`${API}/devices/create/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeModal('add-device-modal');
                    document.getElementById('device-form').reset();
                    loadTopology();
                } else {
                    alert('Error creating device');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function createLink(event) {
            event.preventDefault();
            const data = {
                source_device: document.getElementById('link-source').value,
                target_device: document.getElementById('link-target').value,
                source_interface: document.getElementById('link-source-if').value,
                target_interface: document.getElementById('link-target-if').value,
                bandwidth_capacity: document.getElementById('link-capacity').value
            };

            try {
                const res = await fetch(`${API}/links/create/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeModal('add-link-modal');
                    document.getElementById('link-form').reset();
                    loadTopology();
                } else {
                    alert('Error creating link');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteDevice(deviceId) {
            if (!confirm('Are you sure you want to delete this device?')) return;
            try {
                const res = await fetch(`${API}/devices/${deviceId}/delete/`, { method: 'DELETE' });
                if (res.ok) {
                    loadTopology();
                    document.getElementById('details').innerHTML = '<div class="stat">Device deleted</div>';
                } else {
                    alert('Error deleting device');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteLink(linkId) {
            if (!confirm('Are you sure you want to delete this link?')) return;
            try {
                const res = await fetch(`${API}/links/${linkId}/delete/`, { method: 'DELETE' });
                if (res.ok) {
                    loadTopology();
                    document.getElementById('details').innerHTML = '<div class="stat">Link deleted</div>';
                } else {
                    alert('Error deleting link');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Initialize
        loadPreferences();
        loadTopology();
        setInterval(loadTopology, 30000);
    </script>
</body>
</html>
