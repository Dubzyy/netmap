<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetMap - Network Topology Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-panel: rgba(30, 41, 59, 0.95);
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-tertiary: #64748b;
            --border-color: rgba(148, 163, 184, 0.1);
            --accent-primary: #3b82f6;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --font-display: 'Inter', -apple-system, system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-display);
            overflow: hidden;
            background: var(--bg-secondary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        #cy {
            width: 100%;
            height: 100vh;
            background: var(--bg-primary);
        }

        .toolbar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            box-shadow: var(--shadow-lg);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }

        .toolbar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), #8b5cf6);
            opacity: 0.5;
        }

        .toolbar h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-right: auto;
            letter-spacing: -0.5px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.625rem 1.125rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            font-family: var(--font-display);
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-success {
            background: var(--accent-success);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: var(--accent-danger);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .btn-secondary {
            background: rgba(30, 41, 59, 0.8);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: #1e293b;
            border-color: var(--accent-primary);
        }

        .panel {
            position: absolute;
            top: 80px;
            right: 20px;
            width: 380px;
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            box-shadow: var(--shadow-lg);
            border-radius: 12px;
            padding: 1.5rem;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            z-index: 50;
            border: 1px solid var(--border-color);
        }

        .panel h3 {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 1rem;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }

        .stat:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-family: var(--font-display);
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .checkbox-group input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.5);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .file-input-label:hover {
            border-color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-primary);
        }

        .image-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .image-preview img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(30, 41, 59, 0.5);
            color: var(--text-primary);
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: #1e293b;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #334155;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <h1>‚ö° NetMap</h1>
        <button class="btn" onclick="loadTopology()">üîÑ Refresh</button>
        <button class="btn btn-success" onclick="showAddDeviceModal()">‚ûï Add Device</button>
        <button class="btn btn-success" onclick="showAddLinkModal()">üîó Add Link</button>
        <button class="btn btn-secondary" onclick="cy.fit()">üéØ Fit View</button>
        <button class="btn btn-secondary" onclick="cy.zoom(cy.zoom() * 1.2); cy.center()">üîç+</button>
        <button class="btn btn-secondary" onclick="cy.zoom(cy.zoom() * 0.8); cy.center()">üîç-</button>
        <button class="btn btn-secondary" id="line-toggle-btn" onclick="toggleCurvedLines()">Curved</button>
    </div>

    <div id="cy"></div>

    <div class="panel" id="info-panel">
        <h3>Network Overview</h3>
        <div id="details">
            <div class="stat">
                <span class="stat-label">Click on devices or links for details</span>
            </div>
        </div>
    </div>

    <div class="modal" id="add-device-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Device</h2>
                <button class="close-btn" onclick="closeModal('add-device-modal')">&times;</button>
            </div>
            <form id="device-form" onsubmit="createDevice(event)">
                <div class="form-group">
                    <label>Device Name *</label>
                    <input type="text" id="device-name" required>
                </div>
                <div class="form-group">
                    <label>Device Type *</label>
                    <select id="device-type" required>
                        <option value="firewall">Firewall</option>
                        <option value="switch">Switch</option>
                        <option value="router">Router</option>
                        <option value="hypervisor">Hypervisor</option>
                        <option value="server">Server</option>
                        <option value="isp">ISP/External</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Device Icon (Upload Image)</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="device-icon-file" accept="image/png,image/jpeg,image/svg+xml" onchange="previewImage(event)">
                        <label for="device-icon-file" class="file-input-label">
                            üìÅ Click to upload icon (PNG, JPG, SVG)
                        </label>
                    </div>
                    <div id="image-preview" class="image-preview"></div>
                </div>
                <div class="form-group">
                    <label>IP Address *</label>
                    <input type="text" id="device-ip" required>
                </div>
                <div class="form-group">
                    <label>Prometheus Instance</label>
                    <input type="text" id="device-prometheus">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="device-monitored" checked>
                    <label style="margin: 0;">Has Prometheus Metrics</label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Create Device</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-device-modal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="add-link-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Link</h2>
                <button class="close-btn" onclick="closeModal('add-link-modal')">&times;</button>
            </div>
            <form id="link-form" onsubmit="createLink(event)">
                <div class="form-group">
                    <label>Source Device *</label>
                    <select id="link-source" required></select>
                </div>
                <div class="form-group">
                    <label>Source Interface *</label>
                    <input type="text" id="link-source-if" required>
                </div>
                <div class="form-group">
                    <label>Target Device *</label>
                    <select id="link-target" required></select>
                </div>
                <div class="form-group">
                    <label>Target Interface *</label>
                    <input type="text" id="link-target-if" required>
                </div>
                <div class="form-group">
                    <label>Bandwidth Capacity (Mbps) *</label>
                    <input type="number" id="link-capacity" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Create Link</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-link-modal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="edit-device-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Device</h2>
                <button class="close-btn" onclick="closeModal('edit-device-modal')">&times;</button>
            </div>
            <form id="edit-device-form" onsubmit="updateDevice(event)">
                <input type="hidden" id="edit-device-id">
                <div class="form-group">
                    <label>Device Name *</label>
                    <input type="text" id="edit-device-name" required>
                </div>
                <div class="form-group">
                    <label>Device Type *</label>
                    <select id="edit-device-type" required>
                        <option value="firewall">Firewall</option>
                        <option value="switch">Switch</option>
                        <option value="router">Router</option>
                        <option value="hypervisor">Hypervisor</option>
                        <option value="server">Server</option>
                        <option value="isp">ISP/External</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Device Icon (Upload New Image)</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="edit-device-icon-file" accept="image/png,image/jpeg,image/svg+xml" onchange="previewEditImage(event)">
                        <label for="edit-device-icon-file" class="file-input-label">
                            üìÅ Click to upload new icon (PNG, JPG, SVG)
                        </label>
                    </div>
                    <div id="edit-image-preview" class="image-preview"></div>
                </div>
                <div class="form-group">
                    <label>IP Address *</label>
                    <input type="text" id="edit-device-ip" required>
                </div>
                <div class="form-group">
                    <label>Prometheus Instance</label>
                    <input type="text" id="edit-device-prometheus">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="edit-device-monitored">
                    <label style="margin: 0;">Has Prometheus Metrics</label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-device-modal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="edit-link-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Link</h2>
                <button class="close-btn" onclick="closeModal('edit-link-modal')">&times;</button>
            </div>
            <form id="edit-link-form" onsubmit="updateLink(event)">
                <input type="hidden" id="edit-link-id">
                <div class="form-group">
                    <label>Source Interface *</label>
                    <input type="text" id="edit-link-source-if" required>
                </div>
                <div class="form-group">
                    <label>Target Interface *</label>
                    <input type="text" id="edit-link-target-if" required>
                </div>
                <div class="form-group">
                    <label>Bandwidth Capacity (Mbps) *</label>
                    <input type="number" id="edit-link-capacity" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-link-modal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let cy;
        const API = '/api';
        let allDevices = [];
        let uploadedImageBase64 = '';
        let useCurvedLines = localStorage.getItem('netmap-curved-lines') !== 'false';

        function updateLineToggleButton() {
            document.getElementById('line-toggle-btn').textContent = useCurvedLines ? 'Curved' : 'Straight';
        }

        function toggleCurvedLines() {
            useCurvedLines = !useCurvedLines;
            localStorage.setItem('netmap-curved-lines', useCurvedLines);
            updateLineToggleButton();

            if (cy) {
                cy.style()
                    .selector('edge')
                    .style({
                        'curve-style': useCurvedLines ? 'unbundled-bezier' : 'straight',
                        'control-point-distances': useCurvedLines ? [40, -40] : [],
                        'control-point-weights': useCurvedLines ? [0.25, 0.75] : []
                    })
                    .update();
            }
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImageBase64 = e.target.result;
                document.getElementById('image-preview').innerHTML =
                    `<img src="${uploadedImageBase64}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
        }

        function previewEditImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImageBase64 = e.target.result;
                document.getElementById('edit-image-preview').innerHTML =
                    `<img src="${uploadedImageBase64}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
        }

        async function loadTopology() {
            try {
                const res = await fetch(`${API}/topology/`);
                const data = await res.json();
                allDevices = data.nodes;
                const elements = [];

                data.nodes.forEach(n => {
                    const hasCustomIcon = n.icon && n.icon.startsWith('data:image');
                    elements.push({
                        group: 'nodes',
                        data: {
                            id: String(n.id),
                            label: n.label,
                            type: n.type,
                            ip: n.ip,
                            is_monitored: n.is_monitored,
                            icon: hasCustomIcon ? n.icon : '',
                            hasCustomIcon: hasCustomIcon
                        },
                        position: n.position
                    });
                });

                data.edges.forEach(e => {
                    elements.push({
                        group: 'edges',
                        data: {
                            id: 'edge-' + String(e.id),
                            dbId: e.id,
                            source: String(e.source),
                            target: String(e.target),
                            source_if: e.source_interface,
                            target_if: e.target_interface,
                            bw: e.bandwidth
                        }
                    });
                });

                if (!cy) {
                    initCytoscape(elements);
                } else {
                    const viewport = { zoom: cy.zoom(), pan: cy.pan() };
                    cy.elements().remove();
                    cy.add(elements);
                    cy.layout({ name: 'preset' }).run();
                    setTimeout(() => cy.viewport(viewport), 50);
                }

                document.getElementById('details').innerHTML = `
                    <div class="stat"><span class="stat-label">Updated:</span> <span class="stat-value">${new Date().toLocaleTimeString()}</span></div>
                    <div class="stat"><span class="stat-label">Devices:</span> <span class="stat-value">${data.nodes.length}</span></div>
                    <div class="stat"><span class="stat-label">Links:</span> <span class="stat-value">${data.edges.length}</span></div>
                `;
            } catch (e) {
                console.error('Load error:', e);
            }
        }

        function initCytoscape(elements) {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': ele => ele.data('hasCustomIcon') ? 'transparent' : '#1e293b',
                            'background-opacity': ele => ele.data('hasCustomIcon') ? 0 : 1,
                            'background-image': ele => ele.data('hasCustomIcon') ? ele.data('icon') : 'none',
                            'background-fit': 'contain',
                            'background-clip': 'none',
                            'border-width': ele => ele.data('hasCustomIcon') ? 0 : 2,
                            'border-color': ele => ele.data('hasCustomIcon') ? 'transparent' : '#475569',
                            'border-opacity': ele => ele.data('hasCustomIcon') ? 0 : 1,
                            'label': 'data(label)',
                            'color': '#f1f5f9',
                            'text-valign': ele => ele.data('hasCustomIcon') ? 'bottom' : 'center',
                            'text-halign': 'center',
                            'text-margin-y': ele => ele.data('hasCustomIcon') ? 5 : 0,
                            'width': ele => ele.data('hasCustomIcon') ? 80 : 100,
                            'height': ele => ele.data('hasCustomIcon') ? 80 : 60,
                            'font-size': 12,
                            'font-weight': '600',
                            'font-family': 'Inter, sans-serif',
                            'shape': 'roundrectangle',
                            'text-wrap': 'wrap',
                            'text-max-width': 90,
                            'padding': 0
                        }
                    },
                    {
                        selector: 'node:selected',
                        style: {
                            'border-width': 3,
                            'border-color': '#3b82f6'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': ele => {
                                const bw = ele.data('bw');
                                if (!bw || bw.utilization === undefined) return '#10b981';
                                if (bw.utilization > 80) return '#ef4444';
                                if (bw.utilization > 50) return '#f59e0b';
                                return '#10b981';
                            },
                            'target-arrow-shape': 'none',
                            'source-endpoint': 'outside-to-line',
                            'target-endpoint': 'outside-to-line',
                            'edge-distances': 'node-position',
                            'curve-style': useCurvedLines ? 'unbundled-bezier' : 'straight',
                            'control-point-distances': useCurvedLines ? [40, -40] : [],
                            'control-point-weights': useCurvedLines ? [0.25, 0.75] : [],
                            'label': ele => {
                                const bw = ele.data('bw');
                                if (!bw || (bw.inbound === 0 && bw.outbound === 0)) return '';
                                return `${bw.inbound}M | ${bw.outbound}M`;
                            },
                            'font-size': 9,
                            'font-family': 'JetBrains Mono, monospace',
                            'color': '#94a3b8',
                            'text-background-color': '#0a0e1a',
                            'text-background-opacity': 0.95,
                            'text-background-padding': 2
                        }
                    }
                ],
                layout: { name: 'preset' },
                minZoom: 0.3,
                maxZoom: 3
            });

            cy.on('tap', 'edge', function(evt) {
                const edge = evt.target;
                const bw = edge.data('bw');
                const dbId = edge.data('dbId');

                if (bw) {
                    const utilColor = bw.utilization > 80 ? '#ef4444' : bw.utilization > 50 ? '#f59e0b' : '#10b981';
                    document.getElementById('details').innerHTML = `
                        <h3 style="margin: 0 0 15px 0; font-size: 18px;">${edge.data('source_if')} ‚Üî ${edge.data('target_if')}</h3>
                        <div class="stat"><span class="stat-label">‚Üì Inbound:</span> <span class="stat-value">${bw.inbound} Mbps</span></div>
                        <div class="stat"><span class="stat-label">‚Üë Outbound:</span> <span class="stat-value">${bw.outbound} Mbps</span></div>
                        <div class="stat"><span class="stat-label">Capacity:</span> <span class="stat-value">${bw.capacity} Mbps</span></div>
                        <div class="stat"><span class="stat-label">Utilization:</span> <span style="color: ${utilColor}; font-weight: 600;">${bw.utilization}%</span></div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="showEditLinkModal(${dbId})">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger" onclick="deleteLink(${dbId})">üóëÔ∏è Delete</button>
                        </div>
                    `;
                }
            });

            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                const monitored = node.data('is_monitored') ? 'Yes' : 'No';
                const iconDisplay = node.data('hasCustomIcon') ? '<img src="' + node.data('icon') + '" style="max-width: 80px; margin-bottom: 10px;">' : '';

                document.getElementById('details').innerHTML = `
                    <div style="text-align: center; margin-bottom: 10px;">${iconDisplay}</div>
                    <h3 style="margin: 0 0 15px 0; font-size: 18px; text-align: center;">${node.data('label')}</h3>
                    <div class="stat"><span class="stat-label">Type:</span> <span class="stat-value">${node.data('type')}</span></div>
                    <div class="stat"><span class="stat-label">IP:</span> <span class="stat-value">${node.data('ip')}</span></div>
                    <div class="stat"><span class="stat-label">Monitored:</span> <span class="stat-value">${monitored}</span></div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="showEditDeviceModal(${node.id()})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" onclick="deleteDevice(${node.id()})">üóëÔ∏è Delete</button>
                    </div>
                `;
            });

            cy.on('dragfree', 'node', async function(evt) {
                const node = evt.target;
                const pos = node.position();
                try {
                    await fetch(`${API}/device/${node.id()}/position/`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ x: Math.round(pos.x), y: Math.round(pos.y) })
                    });
                } catch (error) {
                    console.error('Error saving position:', error);
                }
            });
        }

        function showAddDeviceModal() {
            uploadedImageBase64 = '';
            document.getElementById('image-preview').innerHTML = '';
            document.getElementById('add-device-modal').classList.add('active');
        }

        function showAddLinkModal() {
            const sourceSelect = document.getElementById('link-source');
            const targetSelect = document.getElementById('link-target');
            sourceSelect.innerHTML = '';
            targetSelect.innerHTML = '';
            allDevices.forEach(device => {
                sourceSelect.innerHTML += `<option value="${device.id}">${device.label}</option>`;
                targetSelect.innerHTML += `<option value="${device.id}">${device.label}</option>`;
            });
            document.getElementById('add-link-modal').classList.add('active');
        }

        function showEditDeviceModal(deviceId) {
            const device = allDevices.find(d => d.id == deviceId);
            if (!device) return;

            uploadedImageBase64 = '';
            
            // Show current icon if exists
            if (device.icon && device.icon.startsWith('data:image')) {
                document.getElementById('edit-image-preview').innerHTML = 
                    `<img src="${device.icon}" alt="Current Icon">`;
            } else {
                document.getElementById('edit-image-preview').innerHTML = '';
            }

            document.getElementById('edit-device-id').value = device.id;
            document.getElementById('edit-device-name').value = device.label;
            document.getElementById('edit-device-type').value = device.type;
            document.getElementById('edit-device-ip').value = device.ip;
            document.getElementById('edit-device-prometheus').value = device.prometheus_instance || '';
            document.getElementById('edit-device-monitored').checked = device.is_monitored;
            document.getElementById('edit-device-modal').classList.add('active');
        }

        function showEditLinkModal(linkId) {
            fetch(`${API}/links/${linkId}/`)
                .then(res => res.json())
                .then(link => {
                    document.getElementById('edit-link-id').value = link.id;
                    document.getElementById('edit-link-source-if').value = link.source_interface;
                    document.getElementById('edit-link-target-if').value = link.target_interface;
                    document.getElementById('edit-link-capacity').value = link.bandwidth_capacity;
                    document.getElementById('edit-link-modal').classList.add('active');
                });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function createDevice(event) {
            event.preventDefault();
            const data = {
                name: document.getElementById('device-name').value,
                device_type: document.getElementById('device-type').value,
                ip_address: document.getElementById('device-ip').value,
                prometheus_instance: document.getElementById('device-prometheus').value || '',
                is_monitored: document.getElementById('device-monitored').checked,
                icon: uploadedImageBase64,
                position_x: 400,
                position_y: 400
            };

            try {
                const res = await fetch(`${API}/devices/create/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeModal('add-device-modal');
                    document.getElementById('device-form').reset();
                    loadTopology();
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function createLink(event) {
            event.preventDefault();
            const data = {
                source_device: document.getElementById('link-source').value,
                target_device: document.getElementById('link-target').value,
                source_interface: document.getElementById('link-source-if').value,
                target_interface: document.getElementById('link-target-if').value,
                bandwidth_capacity: document.getElementById('link-capacity').value
            };

            try {
                const res = await fetch(`${API}/links/create/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeModal('add-link-modal');
                    document.getElementById('link-form').reset();
                    loadTopology();
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function updateDevice(event) {
            event.preventDefault();
            const deviceId = document.getElementById('edit-device-id').value;
            const data = {
                name: document.getElementById('edit-device-name').value,
                device_type: document.getElementById('edit-device-type').value,
                ip_address: document.getElementById('edit-device-ip').value,
                prometheus_instance: document.getElementById('edit-device-prometheus').value || '',
                is_monitored: document.getElementById('edit-device-monitored').checked
            };

            // Only include icon if a new one was uploaded
            if (uploadedImageBase64) {
                data.icon = uploadedImageBase64;
            }

            try {
                const res = await fetch(`${API}/devices/${deviceId}/update/`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeModal('edit-device-modal');
                    loadTopology();
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function updateLink(event) {
            event.preventDefault();
            const linkId = document.getElementById('edit-link-id').value;
            const data = {
                source_interface: document.getElementById('edit-link-source-if').value,
                target_interface: document.getElementById('edit-link-target-if').value,
                bandwidth_capacity: document.getElementById('edit-link-capacity').value
            };

            try {
                const res = await fetch(`${API}/links/${linkId}/update/`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeModal('edit-link-modal');
                    loadTopology();
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteDevice(deviceId) {
            if (!confirm('Delete this device?')) return;
            try {
                const res = await fetch(`${API}/devices/${deviceId}/delete/`, { method: 'DELETE' });
                if (res.ok) {
                    loadTopology();
                    document.getElementById('details').innerHTML = '<div class="stat"><span class="stat-label">Device deleted</span></div>';
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteLink(linkId) {
            if (!confirm('Delete this link?')) return;
            try {
                const res = await fetch(`${API}/links/${linkId}/delete/`, { method: 'DELETE' });
                if (res.ok) {
                    loadTopology();
                    document.getElementById('details').innerHTML = '<div class="stat"><span class="stat-label">Link deleted</span></div>';
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        updateLineToggleButton();
        loadTopology();
        setInterval(loadTopology, 30000);
    </script>
</body>
</html>
